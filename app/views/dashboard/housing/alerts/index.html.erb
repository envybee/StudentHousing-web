<head>
	<%= render 'shared/common_dash_head' %>
	<!-- DataTables CSS -->
	<link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.5/css/jquery.dataTables.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
	<%= stylesheet_link_tag 'dashboard_housing_alerts_index.css'%>
</head>
<body>
	<%= render 'shared/common_dash_nav' %>
	<div id="container" class="col-sm-9 col-md-10 container">
		<br />
		<section class="panel">
			<section class="panel-heading">
				<h4>
					<i class="fa fa-bell"></i>
					Custom Alerts
				</h4>
			</section>
			<section class="panel-body">
				<button id="new_alert_btn" class="btn btn-sm btn-info">
					<i class="fa fa-bell"></i>
		        	Add Alert
		        </button>
				<br />
				<br />
				<% if @my_alerts.length == 0 %>
					<div class="alert alert-warning">
						You do not have any custom alerts at this moment.
					</div>
				<% else %>
			        <section class='panel'>
			          <section class='panel-body'>
			          	<table id="alerts_table" class="table table-striped table-hover display">
							<thead>
								<tr>
									<th>
										Name
									</th>
									<th>
										Location
									</th>
									<th>
										Delete
									</th>
								</tr>
							</thead>
							<tbody>
								<% @my_alerts.each do |a| %>
								<tr>
									<td><%= a.name %></td>
									<td><%= a.location %></td>
									<td><a class="alert-delete-btn" href="#" data-alert-id="<%=a.id%>">Delete</a></td>
								</tr>
								<%end%>
							</tbody>
						</table>
			          </section>
			        </section>
				<% end %>
			</section>
		</section>
	</div>
	<div class="modal fade" id="new_alert_modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
		<div class="modal-dialog modal-sm modal-info">
		<div class="modal-content">
		  <div class="modal-header">
		  	Add Custom Alert
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		  </div>
		  <div class="modal-body">
		  	<div>
				Name
			</div>
			<div>
				<input id="alert_name_input" name="alert_name_input" style="width: 100%;"></input>
			</div>
			<br />
			<div>
				Address
			</div>
			<div>
				<input id="alert_address_input" style="width: 100%;"></input>
			</div>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
			<button id="alert_submit_btn" type="button" class="btn btn-primary">Submit</button>
		  </div>
		</div><!-- /.modal-content -->
	  </div><!-- /.modal-dialog -->
	</div>
</body>
<%= render 'shared/common_dash_scripts' %>
<!-- DataTables -->
<script type="text/javascript" charset="utf8" src="//cdn.datatables.net/1.10.5/js/jquery.dataTables.js"></script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?libraries=places"></script>

<script>

  	var housing_alert_create_api = "/api/v1/housing/alerts/";

	$("#new_alert_btn").on("click", function(e) {
		$("#new_alert_modal").modal("show");
	});

	$("#alerts_table").DataTable();

	var address_input = document.getElementById('alert_address_input');

    address_autocomplete = new google.maps.places.Autocomplete(address_input, {
        types: ['geocode']
    });

    var place;
    var address_parts = [];

    google.maps.event.addListener(address_autocomplete, 'place_changed', function() {

	  	place = address_autocomplete.getPlace();

	    var componentForm = {
	        street_number: 'short_name',
	        route: 'long_name',
	        locality: 'short_name',
	        administrative_area_level_1: 'short_name',
	        postal_code: 'short_name',
	        postal_code_prefix: 'short_name',
	        country: 'short_name'
	    };

	    for (var i = 0; i < place.address_components.length; i++) {
	        var addressType = place.address_components[i].types[0];

	        if(componentForm[addressType]) {
	            address_parts[addressType] = place.address_components[i][componentForm[addressType]];
	        }
	    }

	});

	$("#alert_submit_btn").on("click", function(e) {
		
		var name = $("#alert_name_input").val();

		if(place) {
		    var street_address = address_parts['street_number'] + " " + address_parts['route'];
		    var city = address_parts['locality'];
		    var postal_code = address_parts['postal_code'].replace(" ", "");
		    var province = address_parts['administrative_area_level_1'];
		    var country = address_parts['country'];
		}

		$.ajax({
		  async: false,
		  method: 'post',
		  url: housing_alert_create_api,
		  data: {
			name: name,
			street_address: street_address,
			city: city,
			province: province,
			country: country
		  },
		  success: function(response){
			window.location.reload();
			console.log(response);
		  },
		  error: function(response) {
			console.log(response);
		  }
		});
	});

	$(".alert-delete-btn").on("click", function(e) {
		e.preventDefault();

		var current_alert_id = $(this).data("alert-id");
  		var housing_alert_delete_api = "/api/v1/housing/alerts/" + current_alert_id;

		$.ajax({
		  async: false,
		  method: 'delete',
		  url: housing_alert_delete_api,
		  success: function(response){
			window.location.reload();
			console.log(response);
		  },
		  error: function(response) {
			console.log(response);
		  }
		});
	})


</script>